# 导盲犬 (Guide Dog) - 技术方案设计

> 桌面AI助手的详细技术实现方案

**文档版本**：v1.0  
**最后更新**：2026-01-08  
**负责人**：哈雅（263321）

---

## 📐 整体架构

### 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                  导盲犬 (Guide Dog) 桌面应用               │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  宠物窗口层   │  │  对话窗口层   │  │  配置管理层   │  │
│  │              │  │              │  │              │  │
│  │ • 小狗图标    │  │ • 输入框      │  │ • API密钥     │  │
│  │ • 点击事件    │  │ • 消息展示    │  │ • 快捷键      │  │
│  │ • 拖拽移动    │  │ • Markdown    │  │ • 位置记忆    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│                                                           │
├─────────────────────────────────────────────────────────┤
│                      核心功能层                            │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 屏幕截图模块  │  │ 粘贴板模块    │  │  AI对话模块   │  │
│  │              │  │              │  │              │  │
│  │ • 全屏截图    │  │ • 读取截图    │  │ • 千问API     │  │
│  │ • 图片压缩    │  │ • Base64转换  │  │ • 上下文管理  │  │
│  │ • 临时存储    │  │ • 格式识别    │  │ • 流式响应    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│                                                           │
├─────────────────────────────────────────────────────────┤
│                      系统接口层                            │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  Electron    │  │  macOS API   │  │   网络层      │  │
│  │              │  │              │  │              │  │
│  │ • 窗口管理    │  │ • 截图权限    │  │ • HTTP Client │  │
│  │ • 快捷键      │  │ • 粘贴板API   │  │ • 重试机制    │  │
│  │ • 进程通信    │  │ • 系统通知    │  │ • 错误处理    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

---

## 🎯 核心模块设计

### 1. 宠物窗口模块

#### 1.1 窗口属性
- **尺寸**：120x120 像素
- **位置**：桌面右下角（可拖拽）
- **特性**：
  - 始终置顶（alwaysOnTop: true）
  - 透明背景（transparent: true）
  - 无边框（frameless: true）
  - 可拖拽（draggable: true）

#### 1.2 交互逻辑
- **点击事件**：打开对话窗口
- **拖拽事件**：记住位置，下次启动恢复
- **悬停效果**：可选的视觉反馈

#### 1.3 实现要点
- 使用 Electron BrowserWindow
- 加载静态图片：`materials/image/icon_dog.png`
- 监听点击事件，触发对话窗口显示
- 保存窗口位置到本地配置

---

### 2. 对话窗口模块

#### 2.1 窗口设计
- **尺寸**：400x600 像素（可调整）
- **位置**：屏幕中央
- **特性**：
  - 普通窗口（非置顶）
  - 可最小化、关闭
  - 不可最大化

#### 2.2 UI组件结构
```
对话窗口
├── 标题栏
│   ├── 图标 + 标题
│   └── 关闭按钮
├── 消息列表区域（可滚动）
│   ├── 用户消息
│   │   ├── 文本内容
│   │   └── 截图预览（如有）
│   └── AI消息
│       ├── Markdown内容
│       └── 复制按钮
└── 输入区域
    ├── 文本输入框
    ├── 选项复选框
    │   ├── 📷 包含当前截图
    │   └── 📋 粘贴板截图
    └── 发送按钮
```

#### 2.3 消息渲染
- **用户消息**：
  - 右对齐
  - 浅色背景
  - 显示截图缩略图
- **AI消息**：
  - 左对齐
  - 深色背景
  - Markdown渲染（react-markdown）
  - 代码高亮（prism-react-renderer）
  - 复制按钮

#### 2.4 交互流程
```
用户输入问题
    ↓
选择截图选项
    ↓
点击发送
    ↓
显示用户消息（含截图预览）
    ↓
显示"思考中..."状态
    ↓
流式显示AI回答
    ↓
完成，显示复制按钮
```

---

### 3. 屏幕截图模块

#### 3.1 截图时机
- 用户点击"发送"按钮时
- 仅在勾选"包含当前截图"时执行

#### 3.2 截图实现
使用 Electron 的 `desktopCapturer` API：
- 获取主显示器
- 截取全屏内容
- 返回 PNG 格式图片

#### 3.3 图片处理
- **格式转换**：转为 Base64 编码
- **Data URL**：构造 `data:image/png;base64,{base64字符串}`
- **不压缩**：直接发送原图，保证最佳质量
- **临时存储**：内存中保存，发送后立即清除

#### 3.4 性能优化
- 截图操作异步执行
- 避免阻塞UI线程
- 单次对话只截图一次
- 不保存到磁盘

---

### 4. 粘贴板模块

#### 4.1 读取时机
- 用户点击"发送"按钮时
- 仅在勾选"粘贴板截图"时执行

#### 4.2 读取逻辑
使用 Electron 的 `clipboard` API：
- 检查粘贴板格式
- 读取图片类型数据
- 转换为 PNG 格式
- Base64 编码

#### 4.3 数据处理
- 仅读取当前粘贴板内容
- 不监控历史变化
- 不保存历史记录
- 读取后不修改粘贴板

---

### 5. AI对话模块

#### 5.1 IdeaLab API集成

**API端点**：
```
https://idealab.alibaba-inc.com/api/openai/v1
```

**使用 OpenAI TypeScript SDK**：
- 兼容 OpenAI API 格式
- 支持流式响应
- 类型安全

**模型选择**：
- `qwen-vl-max-latest`：千问多模态最新版本

**请求格式（使用 OpenAI SDK）**：
```typescript
import OpenAI from 'openai';

const client = new OpenAI({
    apiKey: userConfig.apiKey,
    baseURL: 'https://idealab.alibaba-inc.com/api/openai/v1'
});

// 带图片的对话请求
const completion = await client.chat.completions.create({
    model: "qwen-vl-max-latest",
    messages: [
        {
            role: "system",
            content: "系统提示词"
        },
        {
            role: "user",
            content: [
                { type: "text", text: "用户问题" },
                { 
                    type: "image_url", 
                    image_url: { 
                        url: "data:image/png;base64,..." 
                    }
                }
            ]
        }
    ],
    stream: true  // 启用流式响应
});
```

#### 5.2 系统提示词
```
你是一个桌面AI助手，以可爱的小狗形象出现。

你的能力：
1. 理解用户屏幕上的内容（通过截图）
2. 理解用户粘贴板中的截图
3. 回答用户关于屏幕内容的问题

你的特点：
- 友好、专业、高效
- 回答简洁明了，避免冗长
- 对于技术问题，提供具体的解决方案
- 对于文档问题，提供清晰的总结

注意事项：
- 如果用户没有提供截图，礼貌地提醒
- 如果截图内容不清晰，说明你看到了什么
- 回答时使用 Markdown 格式
- 代码块要指定语言以便高亮
```

#### 5.3 上下文管理

**数据结构**：
```typescript
interface Message {
  role: 'system' | 'user' | 'assistant';
  content: Array<{
    type: 'text' | 'image_url';
    text?: string;
    image_url?: { url: string };
  }>;
}

interface Conversation {
  messages: Message[];
  maxHistory: number; // 10
}
```

**管理策略**：
- 保留系统提示词
- 保留最近10轮对话
- 超出限制时，删除最早的对话
- 关闭窗口时清空历史

#### 5.4 流式响应
- 使用 SSE（Server-Sent Events）
- 逐字显示AI回答
- 提供更好的用户体验
- 支持中断响应

#### 5.5 错误处理
- **网络错误**：自动重试3次
- **API错误**：显示友好错误信息
- **超时处理**：30秒超时
- **限流处理**：提示用户稍后重试

---

### 6. 配置管理模块

#### 6.1 配置项
```typescript
interface Config {
  // 必填
  apiKey: string;           // IdeaLab API密钥
  
  // 可选
  shortcut: string;         // 快捷键（默认：Cmd+Shift+A）
  petPosition: {            // 宠物位置
    x: number;
    y: number;
  };
  model: string;            // 模型选择（默认：qwen-vl-max-latest）
}
```

#### 6.2 存储方式
- 使用 Electron 的 `electron-store`
- 本地 JSON 文件存储
- API密钥加密存储
- 配置文件位置：`~/Library/Application Support/GuideD og/config.json`

#### 6.3 配置界面
- 首次启动引导配置
- 设置菜单随时修改
- 实时验证API密钥
- 提供默认值

---

## 🔄 数据流设计

### 完整交互流程

```
1. 用户唤醒
   点击宠物 / 按快捷键
        ↓
   显示对话窗口

2. 用户输入
   输入问题文本
        ↓
   选择截图选项
   - [x] 包含当前截图
   - [ ] 粘贴板截图
        ↓
   点击发送按钮

3. 数据收集
   ├─ 用户输入文本
   ├─ 当前屏幕截图（如勾选）
   └─ 粘贴板截图（如勾选）
        ↓
   图片处理
   - 压缩
   - Base64编码
   - 添加到消息

4. API调用
   构建请求
   - 系统提示词
   - 历史上下文
   - 当前消息（文本+图片）
        ↓
   发送到千问API
        ↓
   接收流式响应

5. 结果展示
   逐字显示AI回答
        ↓
   Markdown渲染
        ↓
   代码高亮
        ↓
   显示完成，提供复制按钮

6. 后续操作
   - 用户可继续提问（多轮对话）
   - 用户可复制回答
   - 用户可关闭窗口（清空历史）
```

---

## 🎨 技术栈详解

### 前端技术

#### Electron
- **版本**：28+
- **用途**：桌面应用框架
- **关键API**：
  - BrowserWindow：窗口管理
  - desktopCapturer：屏幕截图
  - clipboard：粘贴板操作
  - globalShortcut：全局快捷键

#### React
- **版本**：18
- **用途**：UI框架
- **状态管理**：Zustand（轻量级）
- **关键组件**：
  - PetWindow：宠物窗口
  - ChatWindow：对话窗口
  - MessageList：消息列表
  - InputArea：输入区域

#### Tailwind CSS
- **版本**：3+
- **用途**：样式框架
- **优势**：
  - 快速开发
  - 响应式设计
  - 一致的设计系统

#### 其他UI库
- **react-markdown**：Markdown渲染
- **prism-react-renderer**：代码高亮
- **framer-motion**：动画效果（可选）

### 后端/系统

#### Node.js
- **版本**：18+
- **用途**：运行环境

#### TypeScript
- **版本**：5+
- **用途**：类型安全
- **配置**：严格模式

#### 工具库
- **axios**：HTTP请求
- **electron-store**：配置存储
- **electron-log**：日志记录

---

## 🔒 安全与隐私

### 数据安全

#### API密钥保护
- 本地加密存储
- 不在日志中输出
- 不上传到服务器

#### 截图数据
- 仅内存存储
- 发送后立即清除
- 不保存到磁盘
- 不上传到第三方

#### 对话历史
- 仅会话期间保存
- 关闭窗口清空
- 不持久化存储

### 权限管理

#### 屏幕录制权限
- 首次使用时申请
- macOS系统级权限
- 用户可随时撤销

#### 粘贴板权限
- 首次使用时申请
- 仅读取，不修改
- 用户可随时撤销

#### 网络权限
- 仅访问千问API
- 不访问其他服务
- 支持代理配置

---

## ⚡ 性能优化

### 内存管理
- 对话历史限制10轮
- 图片用完即释放
- 定期垃圾回收

### 网络优化
- 请求超时控制（30秒）
- 失败自动重试（3次）
- 流式响应减少等待

### UI优化
- 虚拟滚动（消息列表）
- 图片懒加载
- 防抖节流（输入框）

### 启动优化
- 延迟加载非关键模块
- 预加载常用资源
- 后台初始化

---

## 🧪 测试策略

### 单元测试
- 核心模块功能测试
- 工具函数测试
- 使用 Vitest

### 集成测试
- 窗口交互测试
- API调用测试
- 使用 Playwright

### 手动测试
- 功能完整性测试
- 用户体验测试
- 性能测试
- 兼容性测试

---

## 📦 构建与发布

### 开发环境
```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 类型检查
npm run type-check

# 代码检查
npm run lint
```

### 构建打包
```bash
# 构建应用
npm run build

# 打包 macOS 应用
npm run package:mac

# 生成安装包
npm run make
```

### 发布流程
1. 版本号更新
2. 构建测试
3. 打包应用
4. 内部测试
5. 发布分发

---

## 🔧 开发规范

### 代码规范
- 使用 ESLint + Prettier
- 遵循 Airbnb 规范
- TypeScript 严格模式

### Git规范
- 使用语义化提交信息
- 功能分支开发
- Code Review

### 文档规范
- 代码注释完整
- API文档清晰
- 更新日志维护

---

## 📊 监控与日志

### 日志记录
- 使用 electron-log
- 分级记录（info/warn/error）
- 详细错误信息记录
- 日志文件位置：`~/Library/Logs/GuideD og/`

### 错误监控
- 捕获未处理异常
- 记录错误堆栈
- 用户友好提示

### 性能监控
- 内存使用监控
- API响应时间
- 窗口渲染性能

---

## 🚀 未来扩展

### 短期计划
- 支持更多AI模型
- 优化截图质量
- 增加快捷指令

### 长期计划
- Windows平台支持
- 宠物动画效果
- 插件系统
- 云端同步

---

**文档版本**：v1.0  
**最后更新**：2026-01-08  
**负责人**：哈雅（263321）
